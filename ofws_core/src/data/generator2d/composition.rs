use crate::data::generator2d::Generator2d;

/// Returns the maximum value generated by one or more generators.
pub struct MaxGenerator {
    generators: Vec<Box<dyn Generator2d>>,
}

impl MaxGenerator {
    pub fn new(generators: Vec<Box<dyn Generator2d>>) -> MaxGenerator {
        MaxGenerator { generators }
    }
}

impl Generator2d for MaxGenerator {
    /// Generates a value for a 2d point (x,y).
    ///
    /// ```
    ///# use ofws_core::data::generator2d::{Generator2d, MockGenerator};
    ///# use ofws_core::data::generator2d::composition::MaxGenerator;
    /// let generator0 = Box::new(MockGenerator::new(3, 4, 11));
    /// let generator1 = Box::new(MockGenerator::new(3, 4, 22));
    /// let generator = MaxGenerator::new(vec![generator0, generator1]);
    ///
    /// assert_eq!(generator.generate(0, 0), 0);
    /// assert_eq!(generator.generate(10, 0), 0);
    /// assert_eq!(generator.generate(0, 20), 0);
    /// assert_eq!(generator.generate(123, 345), 0);
    /// assert_eq!(generator.generate(3, 4), 22);
    /// ```
    fn generate(&self, x: u32, y: u32) -> u8 {
        self.generators
            .iter()
            .map(|g| g.generate(x, y))
            .max()
            .unwrap_or(0)
    }
}

/// Returns the sum generated by one or more generators.
pub struct SumGenerator {
    generators: Vec<Box<dyn Generator2d>>,
}

impl SumGenerator {
    pub fn new(generators: Vec<Box<dyn Generator2d>>) -> SumGenerator {
        SumGenerator { generators }
    }
}

impl Generator2d for SumGenerator {
    /// Generates a value for a 2d point (x,y).
    ///
    /// ```
    ///# use ofws_core::data::generator2d::{Generator2d, MockGenerator};
    ///# use ofws_core::data::generator2d::composition::SumGenerator;
    /// let generator0 = Box::new(MockGenerator::new(3, 4, 11));
    /// let generator1 = Box::new(MockGenerator::new(3, 4, 22));
    /// let generator = SumGenerator::new(vec![generator0, generator1]);
    ///
    /// assert_eq!(generator.generate(0, 0), 0);
    /// assert_eq!(generator.generate(10, 0), 0);
    /// assert_eq!(generator.generate(0, 20), 0);
    /// assert_eq!(generator.generate(123, 345), 0);
    /// assert_eq!(generator.generate(3, 4), 33);
    /// ```
    fn generate(&self, x: u32, y: u32) -> u8 {
        self.generators
            .iter()
            .map(|g| g.generate(x, y))
            .fold(0u8, |sum, value| sum.saturating_add(value))
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use crate::data::generator2d::MockGenerator;

    #[test]
    fn test_sum_generator_with_overflow() {
        let generator0 = Box::new(MockGenerator::new(3, 4, 100));
        let generator1 = Box::new(MockGenerator::new(3, 4, 200));

        let generator = SumGenerator::new(vec![generator0, generator1]);

        assert_eq!(generator.generate(3, 4), u8::max_value());
    }
}
